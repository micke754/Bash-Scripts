#!/bin/zsh
# ~/Bash-Scripts/wezterm-to-repl

clipboard=$(pbpaste)
if [[ -z "$clipboard" ]]; then
    echo "No code to send"
    exit 1
fi

# Get pane info
pane_info=$(wezterm cli list --format json)

# Useful debugging
echo "REPL matches:"
echo "$pane_info" | jq -r '.[] | select(.title | test("> (python|steel|node|julia|ipython|repl)\\b"; "i")) | {pane_id, title}'

# 1. Get current workspace
current_workspace=$(wezterm cli list --format json | jq -r '.[] | select(.is_active == true) | .workspace' | sort | uniq -c | sort -nr | head -1 | awk '{print $2}')

# 2. Filter by workspace + fixed REPL regex
repl_pane_id=$(echo "$pane_info" | jq -r --arg workspace "$current_workspace" \
  '.[] | select(.workspace == $workspace) | select(.title | test("> (python|steel|node|julia|ipython|repl)\\b"; "i")) | .pane_id' | head -1)

# # 3. Fallback: non-Helix in current workspace only
# if [[ -z "$repl_pane_id" || "$repl_pane_id" == "null" ]]; then
#     repl_pane_id=$(echo "$pane_info" | jq -r --arg workspace "$current_workspace" \
#       '.[] | select(.workspace == $workspace) | select(.title | test("> (hx|helix)\\b"; "i") | not) | .pane_id' | head -1)
# fi

if [[ -n "$repl_pane_id" && "$repl_pane_id" != "null" ]]; then
    printf "%s" "$clipboard" | wezterm cli send-text --pane-id "$repl_pane_id" 
    printf "\r" | wezterm cli send-text --no-paste --pane-id "$repl_pane_id" 
    # echo "Sent to pane $repl_pane_id"
else
    echo "No suitable pane found"
    exit 1
fi
